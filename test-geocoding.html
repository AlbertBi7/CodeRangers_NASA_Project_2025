<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Location Search</title>
</head>
<body>
    <h1>Test Location Search</h1>
    <input type="text" id="searchInput" placeholder="Search for a location (e.g., Kottayam)" />
    <button onclick="searchLocation()">Search</button>
    <div id="results"></div>

    <script>
        async function searchWithNominatim(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&limit=15&q=${encodeURIComponent(query)}&addressdetails=1&featuretype=settlement&class=place`
                );

                if (!response.ok) {
                    return [];
                }

                const data = await response.json();
                return data.map(item => ({
                    name: item.address?.city || item.address?.town || item.address?.village || item.display_name.split(',')[0],
                    display_name: item.display_name,
                    lat: parseFloat(item.lat),
                    lon: parseFloat(item.lon),
                    country: item.address?.country,
                    state: item.address?.state || item.address?.region,
                    type: item.type || 'place',
                    importance: item.importance || 0,
                }));
            } catch (error) {
                console.error('Nominatim geocoding error:', error);
                return [];
            }
        }

        async function searchWithPhoton(query) {
            try {
                const response = await fetch(
                    `https://photon.komoot.io/api?q=${encodeURIComponent(query)}&limit=10&layer=city,locality,district,county`
                );

                if (!response.ok) {
                    return [];
                }

                const data = await response.json();
                
                return data.features?.map(feature => ({
                    name: feature.properties.name || feature.properties.city || feature.properties.locality,
                    display_name: [
                        feature.properties.name || feature.properties.city || feature.properties.locality,
                        feature.properties.district,
                        feature.properties.state,
                        feature.properties.country
                    ].filter(Boolean).join(', '),
                    lat: feature.geometry.coordinates[1],
                    lon: feature.geometry.coordinates[0],
                    country: feature.properties.country,
                    state: feature.properties.state,
                    type: feature.properties.osm_value || 'city',
                    importance: 0.5,
                })) || [];
            } catch (error) {
                console.error('Photon geocoding error:', error);
                return [];
            }
        }

        async function searchLocation() {
            const query = document.getElementById('searchInput').value;
            if (!query.trim()) {
                alert('Please enter a location to search');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = 'Searching...';

            try {
                // Run multiple searches in parallel for better coverage
                const [nominatimResults, photonResults] = await Promise.allSettled([
                    searchWithNominatim(query),
                    searchWithPhoton(query)
                ]);

                let allResults = [];

                // Combine results from both services
                if (nominatimResults.status === 'fulfilled') {
                    allResults.push(...nominatimResults.value);
                }

                if (photonResults.status === 'fulfilled') {
                    allResults.push(...photonResults.value);
                }

                // Remove duplicates based on proximity (within ~100m)
                const uniqueResults = allResults.filter((result, index, self) =>
                    index === self.findIndex(r => 
                        Math.abs(r.lat - result.lat) < 0.001 && Math.abs(r.lon - result.lon) < 0.001
                    )
                );

                // Sort by importance and relevance
                const sortedResults = uniqueResults
                    .sort((a, b) => {
                        // Prioritize exact name matches
                        const aExactMatch = a.name.toLowerCase() === query.toLowerCase() ? 1 : 0;
                        const bExactMatch = b.name.toLowerCase() === query.toLowerCase() ? 1 : 0;
                        if (aExactMatch !== bExactMatch) return bExactMatch - aExactMatch;
                        
                        // Then by importance
                        return (b.importance || 0) - (a.importance || 0);
                    })
                    .slice(0, 15);

                if (sortedResults.length > 0) {
                    resultsDiv.innerHTML = '<h3>Found ' + sortedResults.length + ' locations:</h3>' +
                        sortedResults.map(result => 
                            `<div style="border: 1px solid #ccc; margin: 5px; padding: 10px;">
                                <strong>${result.name}</strong> (${result.type || 'place'})<br>
                                <em>${result.display_name}</em><br>
                                <small>Coordinates: ${result.lat.toFixed(4)}, ${result.lon.toFixed(4)}</small><br>
                                <small>Country: ${result.country || 'Unknown'}</small>
                            </div>`
                        ).join('');
                } else {
                    resultsDiv.innerHTML = '<p style="color: red;">No locations found for "' + query + '"</p>';
                }

            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<p style="color: red;">Search failed: ' + error.message + '</p>';
            }
        }

        // Allow Enter key to trigger search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });
    </script>
</body>
</html>